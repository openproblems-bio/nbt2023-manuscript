library(tidyverse)
library(ggbeeswarm)
library(patchwork)

# data files are generated by running 'Rscript scripts/figure1a_generate_data.R'

benchmarks <- yaml::read_yaml("data/benchmarks.yaml")

benchmark_commits <- as_tibble(read.delim("data/benchmark_commits.tsv", sep = "\t")) %>%
  mutate(date = ymd_hms(date))

methods <- sort(unique(unlist(map(benchmarks, "methods"))))
metrics <- sort(unique(unlist(map(benchmarks, "metrics"))))
overlapdf <- map_df(benchmarks, function(bench) {
  crossing(
    Method = bench$methods,
    Metric = bench$metrics
  ) %>% mutate(
    Name = bench$name
  )
}) %>%
  group_by(Method, Metric) %>%
  summarise(n = n(), .groups = "drop")
overlapdf <- bind_rows(
  overlapdf,
  anti_join(
    crossing(Method = methods, Metric = metrics, n = 0),
    overlapdf,
    by = c("Method", "Metric")
  )
) %>%
  mutate(
    Method = factor(Method, levels = methods),
    Metric = factor(Metric, levels = metrics),
    n = factor(n)
  )

grid <- bind_rows(
  tibble(
    x = .5,
    xend = length(metrics) + .5,
    y = seq(.5, length(methods) + .5),
    yend = y
  ),
  tibble(
    x = seq(.5, length(metrics) + .5),
    xend = x,
    y = .5,
    yend = length(methods) + .5
  )
)

g1 <- ggplot(overlapdf) +
  geom_tile(aes(Metric, forcats::fct_rev(Method), fill = n), colour = "#AAAAAA", linewidth = 0.5) +
  scale_fill_brewer(palette = "Reds") +
  labs(fill = "# overlap", y = "Methods") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))


bc <- benchmark_commits %>%
  mutate(name = "Commit") %>%
  bind_rows(map_df(benchmarks, function(ben) as.tibble(ben$dates) %>% mutate(benchmark_name = ben$name, date = ymd(date)))) %>%
  mutate(swarm = name == "Commit" & !grepl("Mereu", benchmark_name))

g2 <- ggplot(bc) +
  geom_path(aes(date, benchmark_name), bc, linewidth = .5, alpha = .5) +
  ggbeeswarm::geom_quasirandom(aes(date, benchmark_name, colour = name, size = name), orientation = "y", bc %>% filter(swarm)) +
  geom_point(aes(date, benchmark_name, colour = name, size = name), bc %>% filter(!swarm)) +
  theme_classic() + 
  scale_colour_manual(values = c(Commit = "#555555", Preprint = "#66c2a5", Publication = "#8da0cb")) +
  scale_size_manual(values = c("Commit" = .25, Preprint = 3, Publication = 3)) +
  labs(colour = "Event type", size = "Event type", x = "Date", y = "Study")

g <- patchwork::wrap_plots(g1, g2, nrow = 1)

ggsave("figures/figure1/fig1a.pdf", g, width = 12, height = 5)
